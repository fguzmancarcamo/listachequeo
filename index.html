<!-- 
  Sistema NEXUS Compliance System v3.1 - Casa Betel
  Implementación de:
  1. Justificación Legal de Pendientes en Reporte PDF (basado en DTO N° 4/2009).
  2. Integración del texto completo de los Artículos 3, 4, 5, 6, 11, 14 y 18.
  3. Mantiene Trazabilidad y Gestión de Evidencia (Notas).
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASA BETEL | Nexus Compliance System</title>
    <!-- Incluir Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Incluir jsPDF para la generación de reportes en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        html { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #22d3ee; }

        /* Estilos para el interruptor de cumplimiento (toggle) */
        .toggle-container { position: relative; width: 48px; height: 24px; }
        .toggle-checkbox {
            position: absolute; display: block; width: 24px; height: 24px;
            border-radius: 50%; background-color: white; border: 4px solid;
            appearance: none; cursor: pointer; transition: all 0.3s ease-in-out;
            top: 50%; transform: translateY(-50%); left: 0;
        }
        .toggle-checkbox:checked { right: 0; left: auto; border-color: #22d3ee; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22d3ee; }
        .toggle-label {
            display: block; overflow: hidden; height: 24px; border-radius: 9999px;
            background-color: #475569; cursor: pointer; transition: background-color 0.3s;
        }
        
        /* Efecto de panel de vidrio para Cyberpunk minimalista */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .chart-container {
            position: relative; width: 100%; max-width: 100%; height: 300px; margin: 0 auto;
        }
        @media (min-width: 1024px) { .chart-container { height: 350px; } }
        
        /* Animación para la transición de login */
        .fade-out { animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased overflow-hidden selection:bg-cyan-500 selection:text-white">

    <!-- PANTALLA DE INICIO DE SESIÓN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-cyan-400">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-800 border border-cyan-500 text-cyan-400 text-3xl font-bold mb-4 shadow-[0_0_15px_rgba(34,211,238,0.3)]">
                    N
                </div>
                <h1 class="text-2xl font-bold text-white tracking-widest">NEXUS SYSTEM</h1>
                <p class="text-slate-400 text-sm mt-1">Casa Betel | Acceso Restringido</p>
            </div>
            
            <form id="login-form" class="space-y-6" onsubmit="event.preventDefault(); app.attemptLogin();">
                <div>
                    <label class="block text-slate-400 text-xs font-bold mb-2 uppercase tracking-wider">Usuario</label>
                    <input type="text" id="username" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 transition-all" placeholder="Ingrese usuario..." value="admin">
                </div>
                <div>
                    <label class="block text-slate-400 text-xs font-bold mb-2 uppercase tracking-wider">Contraseña</label>
                    <input type="password" id="password" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 transition-all" placeholder="Ingrese contraseña..." value="1234">
                </div>
                
                <div id="login-error" class="hidden text-red-400 text-sm text-center font-semibold bg-red-900/20 p-2 rounded">
                    Credenciales incorrectas
                </div>

                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-cyan-900/20 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                    INICIAR SESIÓN
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-slate-600">
                Personal Autorizado • v3.1 (admin/1234)
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL DE LA APLICACIÓN -->
    <div id="main-app" class="flex h-screen w-full hidden opacity-0 transition-opacity duration-500">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 flex-shrink-0 border-r border-slate-800 bg-slate-900 flex flex-col transition-all duration-300">
            <div class="h-20 flex items-center justify-center border-b border-slate-800">
                <div class="text-cyan-400 font-bold text-2xl tracking-widest hidden lg:block">NEXUS</div>
                <div class="text-cyan-400 font-bold text-2xl lg:hidden">N</div>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 space-y-2">
                <!-- Botón Dashboard -->
                <button onclick="router.navigate('dashboard')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-slate-800 text-slate-400 hover:text-cyan-400 transition-colors border-l-4 border-transparent hover:border-cyan-400 group">
                    <span class="text-xl group-hover:scale-110 transition-transform">&#8862;</span>
                    <span class="ml-4 font-medium hidden lg:block">Dashboard</span>
                </button>
                <!-- Botón Matriz -->
                <button onclick="router.navigate('matrix')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-slate-800 text-slate-400 hover:text-cyan-400 transition-colors border-l-4 border-transparent hover:border-cyan-400 group">
                    <span class="text-xl group-hover:scale-110 transition-transform">&#9745;</span>
                    <span class="ml-4 font-medium hidden lg:block">Matriz</span>
                </button>
                <!-- Botón Personal (Calculador) -->
                <button onclick="router.navigate('calculator')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-slate-800 text-slate-400 hover:text-cyan-400 transition-colors border-l-4 border-transparent hover:border-cyan-400 group">
                    <span class="text-xl group-hover:scale-110 transition-transform">&#9881;</span>
                    <span class="ml-4 font-medium hidden lg:block">Personal</span>
                </button>
                <!-- Botón Código -->
                <button onclick="router.navigate('codex')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-slate-800 text-slate-400 hover:text-cyan-400 transition-colors border-l-4 border-transparent hover:border-cyan-400 group">
                    <span class="text-xl group-hover:scale-110 transition-transform">&#128214;</span>
                    <span class="ml-4 font-medium hidden lg:block">Código</span>
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center lg:text-left">
                <!-- Botón Cerrar Sesión -->
                <button onclick="app.logout()" class="w-full flex items-center justify-center lg:justify-start gap-2 text-red-400 hover:text-red-300 transition-colors mb-2 p-2 hover:bg-slate-800 rounded">
                    <span>&#9032;</span> <span class="hidden lg:inline">Cerrar Sesión</span>
                </button>
                <p class="hidden lg:block">Casa Betel System</p>
                <p class="font-mono mt-1">v3.1 <span class="text-green-500">&#9679;</span> Online</p>
            </div>
        </aside>

        <!-- Área de Contenido Principal -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-gradient-to-br from-slate-950 to-slate-900">
            <header class="h-20 border-b border-slate-800 flex items-center justify-between px-8 glass-panel z-10">
                <div>
                    <h1 class="text-xl lg:text-2xl font-bold text-white tracking-tight">CASA BETEL <span class="text-cyan-400 font-light">| Protocolo</span></h1>
                    <p class="text-xs text-slate-400 font-mono mt-1">DTO. N° 4/2009 - Gestión de Evidencia</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Botón de Descarga de Reporte -->
                    <button onclick="app.downloadReport()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-xl shadow-[0_0_15px_rgba(8,145,178,0.5)] transition-all flex items-center gap-2 font-bold text-sm">
                        <span>&#11015;</span> Informe PDF
                    </button>
                    <div class="h-10 w-10 rounded-full bg-slate-800 border border-cyan-900 flex items-center justify-center text-cyan-400 font-bold">CB</div>
                </div>
            </header>

            <!-- Contenedor de Vistas -->
            <div id="view-container" class="flex-1 overflow-y-auto p-4 lg:p-8 space-y-8 relative"></div>

            <!-- Modal de Notificación Genérica (Reemplaza a alert()) -->
            <div id="app-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
                <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border-t-4 border-cyan-400">
                    <h3 id="modal-title" class="text-xl font-bold text-white mb-3">Notificación</h3>
                    <p id="modal-message" class="text-slate-300 text-sm mb-4">Mensaje.</p>
                    <button onclick="app.closeModal()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-semibold py-2 rounded-lg">Aceptar</button>
                </div>
            </div>

            <!-- Modal de Notas/Evidencia (Gestión de Trazabilidad) -->
            <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
                <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-md w-full border border-slate-600">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">Gestión de Evidencia</h3>
                        <button onclick="app.closeNotesModal()" class="text-slate-400 hover:text-white">&times;</button>
                    </div>
                    <p id="note-item-title" class="text-cyan-400 text-sm font-semibold mb-2"></p>
                    <p class="text-xs text-slate-500 mb-4">Ingrese ubicación física, folio o comentarios para auditoría (Máx 255 caracteres).</p>
                    
                    <textarea id="note-input" class="w-full h-32 bg-slate-900 border border-slate-700 rounded-lg p-3 text-slate-300 text-sm focus:border-cyan-400 focus:outline-none mb-4" placeholder="Ej: Carpeta 3, Estante B. Vence el 12/2025..." maxlength="255"></textarea>
                    
                    <div class="flex justify-end gap-3">
                        <button onclick="app.closeNotesModal()" class="px-4 py-2 text-slate-300 hover:text-white text-sm">Cancelar</button>
                        <button onclick="app.saveNote()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-cyan-900/20">Guardar Evidencia</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- TEXTO COMPLETO DE ARTÍCULOS DTO N° 4/2009 (Justificación Legal) ---
        // Este objeto contiene la base legal para justificar los ítems pendientes.
        const regulationText = {
            'Art 3': 'El Centro deberá contar con los siguientes documentos: 1. Programa Terapéutico. 2. Plan individual de tratamiento (PIT). 3. Ficha u hoja clínica que registre la evolución. 4. Informe de evaluación final al momento del alta. 5. Documento de organización y funcionamiento interno. 6. Registro estadístico actualizado. 7. Material de consulta de la normativa. 8. Procedimiento explícito para acceso a atención médica de urgencia. 9. Nómina de establecimientos de psiquiatría o salud mental para referencia. 10. Plan de emergencias y prevención de riesgos.',
            'Art 4': 'Los Centros deberán contar con infraestructura libre de riesgos estructurales. Estas condiciones se verificarán en: Muros, pisos y cielos en buen estado. Instalaciones sanitarias en buen estado. Iluminación natural y artificial. Mecanismos de calefacción seguros. Plan de mantención de equipamiento.',
            'Art 5': 'Las instalaciones deberán contar con: a) Servicios higiénicos (1 taza y 1 lavatorio por cada 10 usuarios simultáneos). b) Al menos una sala por cada 15 usuarios para entrevistas privadas. c) Sala de estar o usos múltiples. d) Zonas exteriores para recreación, patio, terraza o jardín. e) Contenedor hermético de almacenamiento transitorio de basura. f) Lugar destinado a guardar los útiles de aseo. g) Dependencia para la preparación de alimentos cuando sea necesario. Debe contar con Botiquín autorizado.',
            'Art 6': 'En el caso de corresponder a un Centro residencial, se deberán agregar las siguientes exigencias: a) Comedor o comedores suficientes para el uso simultáneo de al menos el 50% de los residentes. b) Dormitorios con un máximo de cuatro camas con 1,5 metros entre bordes. c) Guardarropa o clóset con espacio adecuado para cada usuario. d) Un baño con ducha, una taza y un lavamanos por cada cinco residentes. e) La cocina deberá cumplir con condiciones higiénicas y sanitarias. f) Dependencia interna o techada para lavadero con implementación.',
            'Art 11': 'El Director Técnico debe ser un profesional del área de la salud con experiencia no inferior a 3 años en tratamiento de alcohol y drogas, o un técnico en rehabilitación con a lo menos 5 años de experiencia y capacitación demostrable.',
            'Art 14': 'El Centro deberá contar con un equipo base de profesionales y técnicos en rehabilitación, con idoneidad y experiencia en la atención a las personas con consumo problemático, con el número de profesionales que le permita cumplir con la intensidad del programa terapéutico ofrecido. Dicho equipo debe incluir un Médico y un Psicólogo, además de otros profesionales, según la complejidad.',
            'Art 18': 'El Centro deberá contar en forma permanente con personal de apoyo que asegure la supervisión de la vida cotidiana de los usuarios y que permita el cumplimiento del programa. Se debe contar con una relación mínima de 2 funcionarios por cada 15 usuarios o fracción superior a 15, las 24 horas del día, los 7 días de la semana, para programas residenciales.'
        };

        // Definición de los requerimientos basados en el DTO N° 4/2009
        const regulationData = {
            sections: [
                {
                    id: 'docs', title: 'I. Documentación', icon: '&#128196;', description: 'Documentos obligatorios según Art 3.',
                    items: [
                        {id: 'd1', text: 'Programa Terapéutico', ref: 'Art 3'}, {id: 'd2', text: 'Plan Individual (PIT)', ref: 'Art 3'},
                        {id: 'd3', text: 'Ficha Clínica', ref: 'Art 3'}, {id: 'd4', text: 'Informe de Alta', ref: 'Art 3'},
                        {id: 'd5', text: 'Manual Org. Interna', ref: 'Art 3'}, {id: 'd6', text: 'Registro Estadístico', ref: 'Art 3'},
                        {id: 'd7', text: 'Material Legal', ref: 'Art 3'}, {id: 'd8', text: 'Acceso Urgencia Médica', ref: 'Art 3'},
                        {id: 'd9', text: 'Red Psiquiátrica', ref: 'Art 3'}, {id: 'd10', text: 'Plan Emergencias', ref: 'Art 3'}
                    ]
                },
                {
                    id: 'infra', title: 'II. Infraestructura', icon: '&#127963;', description: 'Condiciones físicas según Art 4 y 5.',
                    items: [
                        {id: 'i1', text: 'Estructura Segura', ref: 'Art 4'}, {id: 'i2', text: 'Estado Muros/Pisos', ref: 'Art 4'},
                        {id: 'i3', text: 'Instalaciones Sanitarias', ref: 'Art 4'}, {id: 'i4', text: '1 Baño/10 Usuarios', ref: 'Art 5'},
                        {id: 'i5', text: 'Sala Entrevista (1/15)', ref: 'Art 5'}, {id: 'i6', text: 'Sala Multiuso', ref: 'Art 5'},
                        {id: 'i7', text: 'Área Verde/Patio', ref: 'Art 5'}, {id: 'i8', text: 'Basura Hermética', ref: 'Art 5'},
                        {id: 'i9', text: 'Botiquín Autorizado', ref: 'Art 5'}
                    ]
                },
                {
                    id: 'res', title: 'III. Residencial', icon: '&#128716;', description: 'Requisitos de pernoctación según Art 6.',
                    items: [
                        {id: 'r1', text: 'Comedor (50% cap)', ref: 'Art 6'}, {id: 'r2', text: 'Dormitorios (Max 4)', ref: 'Art 6'},
                        {id: 'r3', text: 'Espacio Camas (1.5m)', ref: 'Art 6'}, {id: 'r4', text: 'Clóset Individual', ref: 'Art 6'},
                        {id: 'r5', text: '1 Ducha/5 Res.', ref: 'Art 6'}, {id: 'r6', text: 'Cocina Higiénica', ref: 'Art 6'},
                        {id: 'r7', text: 'Lavandería', ref: 'Art 6'}
                    ]
                },
                {
                    id: 'stf', title: 'IV. Personal', icon: '&#128101;', description: 'Equipo técnico según Art 11, 14, 18.',
                    items: [
                        {id: 's1', text: 'Director Técnico (Experiencia)', ref: 'Art 11'}, 
                        {id: 's2', text: 'Equipo Base Mínimo (Médico, Psicólogo, etc.)', ref: 'Art 14'},
                        {id: 's3', text: 'Ratio 2/15 (24/7) - Personal de Apoyo', ref: 'Art 18'}, 
                        {id: 's4', text: 'Nómina Personal y Contratos', ref: 'Art 14'}
                    ]
                }
            ]
        };

        // Estado de la Aplicación (Almacenamiento Local)
        const appState = { 
            status: {},         // Booleano: Cumple / No Cumple
            notes: {},          // String: Notas de Evidencia/Ubicación
            timestamps: {},     // String: Fecha de la última modificación (Trazabilidad)
            currentView: 'dashboard', 
            census: 15,         // Censo de residentes
            staffCount: 2,      // Conteo de personal
            currentEditId: null // ID del ítem que se está editando en el modal
        };
        
        // Cargar estado desde localStorage y asegurar que todos los ítems existen
        try { Object.assign(appState, JSON.parse(localStorage.getItem('casaBetelState') || '{}')); } catch(e){ console.error("Error loading state:", e); }
        regulationData.sections.forEach(s => s.items.forEach(i => { 
            if(appState.status[i.id] === undefined) appState.status[i.id] = false; 
            if(appState.notes[i.id] === undefined) appState.notes[i.id] = '';
            if(appState.timestamps[i.id] === undefined) appState.timestamps[i.id] = null;
        }));

        let radarChart = null, doughnutChart = null;

        const views = {
            // --- DASHBOARD VIEW ---
            dashboard: () => {
                const total = Object.keys(appState.status).length;
                const completed = Object.values(appState.status).filter(v => v).length;
                const percent = Math.round((completed / total) * 100) || 0;
                return `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Panel de Estado General -->
                        <div class="col-span-1 lg:col-span-3 glass-panel p-6 rounded-xl border-l-4 border-cyan-400 shadow-lg">
                            <h2 class="text-2xl font-bold text-white">Estado: <span class="${percent===100?'text-green-400':'text-cyan-400'}">${percent===100?'ÓPTIMO':'ACTIVO'}</span></h2>
                            <p class="text-slate-400 mt-1">Cumplimiento D.S. N° 4/2009: <strong class="text-white">${percent}%</strong></p>
                        </div>
                        
                        <!-- Gráfico Radar (Cumplimiento por Sección) -->
                        <div class="col-span-1 lg:col-span-2 glass-panel p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-slate-300 mb-4">Progreso por Sección</h3>
                            <div class="chart-container"><canvas id="mainChart"></canvas></div>
                        </div>
                        
                        <!-- Gráfico Donut (Avance Global) -->
                        <div class="col-span-1 space-y-4">
                            <div class="glass-panel p-6 rounded-xl flex flex-col items-center justify-center h-full shadow-lg">
                                <h3 class="text-lg font-semibold text-slate-300 mb-4">Avance Global</h3>
                                <div class="relative h-40 w-40"><canvas id="doughnutChart"></canvas>
                                    <div class="absolute inset-0 flex items-center justify-center font-bold text-2xl text-white pointer-events-none">${percent}%</div>
                                </div>
                                <div class="mt-4 text-center text-sm text-slate-400">
                                    <span class="text-green-400 font-bold">${completed}</span> Cumplidos / 
                                    <span class="text-red-400 font-bold">${total-completed}</span> Pendientes
                                </div>
                            </div>
                        </div>
                    </div>`;
            },

            // --- MATRIX VIEW (CORE) ---
            matrix: () => `
                <div class="space-y-6 pb-20">
                    <h2 class="text-2xl font-bold text-white">Matriz de Cumplimiento & Evidencia (Trazabilidad)</h2>
                    <div class="grid gap-6">
                        ${regulationData.sections.map(s => `
                            <div class="glass-panel rounded-xl overflow-hidden shadow-xl">
                                <div class="bg-slate-900/80 p-4 border-b border-slate-700 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-200 text-lg"><span class="text-cyan-400 mr-2">${s.icon}</span>${s.title}</h3>
                                    <span class="text-xs bg-cyan-900/30 text-cyan-400 px-3 py-1 rounded-full font-semibold">${s.items.filter(i=>appState.status[i.id]).length}/${s.items.length}</span>
                                </div>
                                <div class="p-4 grid md:grid-cols-2 gap-4">
                                    ${s.items.map(i => {
                                        const timestamp = appState.timestamps[i.id];
                                        const noteExists = appState.notes[i.id] && appState.notes[i.id].trim() !== '';
                                        const formattedDate = timestamp ? new Date(timestamp).toLocaleDateString('es-CL') : 'N/A';
                                        
                                        return `
                                        <div class="flex flex-col p-4 bg-slate-950/50 rounded-lg border ${noteExists ? 'border-cyan-700' : 'border-slate-800'} transition hover:border-slate-600">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="pr-4 flex-1">
                                                    <div class="text-base text-slate-300 font-medium">${i.text}</div>
                                                    <div class="text-xs text-slate-600">${i.ref}</div>
                                                </div>
                                                <!-- Contenedor del Interruptor -->
                                                <div class="relative toggle-container flex-shrink-0">
                                                    <input type="checkbox" id="${i.id}" class="toggle-checkbox" ${appState.status[i.id]?'checked':''} onchange="app.toggleItem('${i.id}')">
                                                    <label for="${i.id}" class="toggle-label ${appState.status[i.id]?'bg-cyan-600':''}"></label>
                                                </div>
                                            </div>

                                            <!-- SECCIÓN DE TRAZABILIDAD Y EVIDENCIA -->
                                            <div class="flex items-center justify-between mt-1 border-t border-slate-800 pt-2">
                                                <div class="text-xs text-slate-500 font-mono">
                                                    Última Mod: <span class="${timestamp ? 'text-slate-300' : 'text-slate-600'}">${formattedDate}</span>
                                                </div>
                                                <button onclick="app.openNotesModal('${i.id}', \`${i.text}\`)" 
                                                        class="flex items-center gap-1 px-2 py-1 rounded hover:bg-slate-800/80 text-xs transition-colors ${noteExists ? 'text-cyan-400 font-bold' : 'text-slate-500 hover:text-cyan-400'}">
                                                    <span>${noteExists ? '&#128221; Evidencia OK' : '&#9998; Agregar Nota'}</span>
                                                </button>
                                            </div>
                                            <!-- FIN SECCIÓN TRAZABILIDAD Y EVIDENCIA -->
                                        </div>
                                    `;}).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`,

            // --- CALCULATOR VIEW (PERSONAL) ---
            calculator: () => {
                const req = Math.ceil((appState.census/15)*2); // Art. 18 Ratio (2/15)
                const ok = appState.staffCount >= req;
                // Función utilitaria para dibujar círculos (residentes/profesionales)
                const dots = (n, c, isStaff) => Array(parseInt(n)).fill(0).map((_,i)=>`<div class="w-${isStaff?'8':'3'} h-${isStaff?'8':'3'} rounded-full ${c} ${isStaff?'border-2 border-white flex items-center justify-center text-xs font-bold text-white shadow-lg':''}" title="${isStaff?'Profesional':'Residente'}">${isStaff?'P':''}</div>`).join('');
                return `
                    <div class="grid lg:grid-cols-2 gap-8 h-full">
                        <!-- Controles de Censo y Personal -->
                        <div class="glass-panel p-8 rounded-xl space-y-8 shadow-xl">
                            <h2 class="text-2xl font-bold text-white border-b border-slate-700 pb-3">Calculador RR.HH. (Art. 18)</h2>
                            <p class="text-sm text-slate-400 italic bg-slate-900/50 p-3 rounded-lg border-l-4 border-yellow-500">
                                <span class="font-bold text-yellow-400">NOTA CRÍTICA (Art. 14):</span> Además del ratio numérico, se exige un Equipo Base Mínimo (Médico, Psicólogo, Técnico en Rehabilitación, etc.). Este calculador solo valida el ratio numérico 2/15.
                            </p>
                            <div>
                                <label class="block text-cyan-400 font-bold mb-2">Residentes: ${appState.census}</label>
                                <input type="range" min="1" max="100" value="${appState.census}" class="w-full accent-cyan-400" oninput="app.updateCensus(this.value)">
                            </div>
                            <div>
                                <label class="block text-purple-400 font-bold mb-2">Personal de Apoyo (Turno): ${appState.staffCount}</label>
                                <div class="flex gap-4 items-center">
                                    <button onclick="app.updateStaff(-1)" class="w-10 h-10 bg-slate-800 rounded hover:bg-red-800/50 text-white font-bold transition">-</button>
                                    <span class="text-2xl font-mono text-white">${appState.staffCount}</span>
                                    <button onclick="app.updateStaff(1)" class="w-10 h-10 bg-slate-800 rounded hover:bg-green-800/50 text-white font-bold transition">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- Resultado Visual -->
                        <div class="glass-panel p-8 rounded-xl flex flex-col relative overflow-hidden shadow-xl">
                            <div class="z-10 relative mb-4">
                                <div class="text-4xl font-bold ${ok?'text-green-400':'text-red-500'}">${ok?'CUMPLIMIENTO NUMÉRICO':'DÉFICIT DE PERSONAL'}</div>
                                <p class="text-slate-400 mt-2">Requeridos (mínimo): <strong class="text-white">${req}</strong> | Brecha: <strong class="${appState.staffCount-req>=0?'text-green-400':'text-red-400'}">${appState.staffCount-req}</strong></p>
                            </div>
                            <div class="flex-1 bg-slate-900/50 rounded border border-slate-700 p-4 relative overflow-hidden">
                                <!-- Representación de Residentes -->
                                <p class="text-slate-500 text-sm mb-2">Residentes (Máx 60):</p>
                                <div class="flex flex-wrap content-start gap-1 mb-4 h-1/2 overflow-y-auto">${dots(Math.min(appState.census,60), 'bg-slate-600', false)}</div>
                                <!-- Representación de Personal -->
                                <p class="text-slate-500 text-sm mb-2 border-t border-slate-800 pt-2">Personal (Ratio):</p>
                                <div class="flex flex-wrap gap-2 justify-start h-1/2 overflow-y-auto">${dots(Math.min(appState.staffCount,15), 'bg-purple-500', true)}</div>
                            </div>
                        </div>
                    </div>`;
            },
            
            // --- CODEX VIEW (REFERENCIA RÁPIDA) ---
            codex: () => `
                <div class="glass-panel p-8 rounded-xl h-full flex flex-col shadow-xl">
                    <h2 class="text-2xl font-bold text-white mb-4">Código DTO N°4 (Referencia Rápida)</h2>
                    <input type="text" placeholder="Buscar por Artículo o Requisito..." class="bg-slate-900 border border-slate-700 text-white p-3 rounded mb-4 focus:border-cyan-400 outline-none" onkeyup="app.filterCodex(this.value)">
                    <div class="overflow-y-auto space-y-2 pr-2 flex-1">
                        ${regulationData.sections.flatMap(s=>s.items.map(i=>`
                            <div class="codex-item p-3 border border-slate-800 rounded hover:bg-slate-800/50" data-section="${s.title}">
                                <div class="flex justify-between">
                                    <span class="font-bold text-cyan-400">${s.title.split('. ')[0]} | ${i.ref}</span>
                                    <span class="text-xs px-2 py-1 rounded ${appState.status[i.id]?'bg-green-900 text-green-300':'bg-red-900 text-red-300'}">${appState.status[i.id]?'CUMPLE':'PENDIENTE'}</span>
                                </div>
                                <p class="text-slate-300 text-sm mt-1">${i.text}</p>
                                ${appState.notes[i.id] ? `<p class="text-xs text-slate-500 italic mt-1">&#128221; Evidencia: ${appState.notes[i.id]}</p>` : ''}
                            </div>
                        `)).join('')}
                    </div>
                </div>`
        };

        const app = {
            // Inicialización y Autenticación
            init: () => { 
                // Usamos sessionStorage para simular una sesión activa
                if(sessionStorage.getItem('nexus_session') === 'active') {
                    document.getElementById('login-screen').classList.add('hidden');
                    const main = document.getElementById('main-app');
                    main.classList.remove('hidden', 'opacity-0');
                    router.navigate('dashboard');
                }
            },
            attemptLogin: () => {
                const u = document.getElementById('username').value, p = document.getElementById('password').value;
                if (u === 'admin' && p === '1234') { // Credenciales hardcodeadas por simplicidad
                    document.getElementById('login-error').classList.add('hidden');
                    sessionStorage.setItem('nexus_session', 'active');
                    document.getElementById('login-screen').classList.add('fade-out');
                    setTimeout(() => {
                        document.getElementById('login-screen').classList.add('hidden');
                        const main = document.getElementById('main-app');
                        main.classList.remove('hidden');
                        setTimeout(() => main.classList.remove('opacity-0'), 50);
                        router.navigate('dashboard');
                    }, 500);
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                    document.getElementById('password').value = '';
                }
            },
            logout: () => { sessionStorage.removeItem('nexus_session'); location.reload(); },

            // Funcionalidad de la Matriz
            toggleItem: (id) => {
                appState.status[id] = !appState.status[id];
                appState.timestamps[id] = new Date().toISOString(); // Trazabilidad: Registrar fecha de cambio
                app.save();
                
                // Actualizar visualmente el botón (por si no se recarga la vista)
                const chk = document.getElementById(id);
                if(chk) {
                    const lbl = document.querySelector(`label[for="${id}"]`);
                    chk.classList.toggle('border-cyan-400', appState.status[id]);
                    lbl.classList.toggle('bg-cyan-600', appState.status[id]);
                }
                
                // Recargar para mostrar timestamp actualizado en la matriz
                if(appState.currentView === 'matrix') router.navigate('matrix'); 
                if(appState.currentView === 'dashboard') app.renderCharts();
            },
            
            // Funcionalidad de Notas de Evidencia (Gestión de Evidencia)
            openNotesModal: (id, text) => {
                appState.currentEditId = id;
                document.getElementById('note-item-title').innerText = text;
                document.getElementById('note-input').value = appState.notes[id] || '';
                document.getElementById('notes-modal').classList.replace('hidden', 'flex');
            },
            closeNotesModal: () => {
                document.getElementById('notes-modal').classList.replace('flex', 'hidden');
                appState.currentEditId = null;
            },
            saveNote: () => {
                if(appState.currentEditId) {
                    const val = document.getElementById('note-input').value.trim();
                    appState.notes[appState.currentEditId] = val;
                    appState.timestamps[appState.currentEditId] = new Date().toISOString(); // Trazabilidad: La nota también actualiza el timestamp
                    app.save();
                    app.closeNotesModal();
                    router.navigate('matrix'); // Recargar para mostrar el ícono de "Evidencia OK"
                }
            },

            // Funcionalidad General
            save: () => localStorage.setItem('casaBetelState', JSON.stringify(appState)),
            showModal: (t, m) => { 
                document.getElementById('modal-title').innerText=t; 
                document.getElementById('modal-message').innerText=m; 
                document.getElementById('app-modal').classList.replace('hidden','flex'); 
            },
            closeModal: () => document.getElementById('app-modal').classList.replace('flex','hidden'),

            // Funcionalidad Calculadora (Personal)
            updateCensus: (v) => { appState.census = parseInt(v); app.save(); router.navigate('calculator'); },
            updateStaff: (d) => { if(appState.staffCount+d >= 0) { appState.staffCount += d; app.save(); router.navigate('calculator'); } },
            
            // Funcionalidad Codex
            filterCodex: (q) => { 
                document.querySelectorAll('.codex-item').forEach(e => {
                    const textContent = e.innerText.toLowerCase();
                    e.style.display = textContent.includes(q.toLowerCase()) ? 'block' : 'none'; 
                }); 
            },

            // Gráficos (Dashboard)
            renderCharts: () => {
                if(appState.currentView !== 'dashboard') return;
                
                // 1. Gráfico Radar
                const labels = regulationData.sections.map(s => s.title.split('. ')[1]);
                const data = regulationData.sections.map(s => (s.items.filter(i=>appState.status[i.id]).length/s.items.length)*100);
                const ctx1 = document.getElementById('mainChart');
                if(ctx1) {
                    if(radarChart) radarChart.destroy();
                    radarChart = new Chart(ctx1, {
                        type: 'radar',
                        data: { labels, datasets: [{ label: 'Cumplimiento (%)', data, backgroundColor: 'rgba(34,211,238,0.2)', borderColor: '#22d3ee', pointBackgroundColor: '#fff' }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { legend: { display: false } } }
                    });
                }
                
                // 2. Gráfico Donut
                const ctx2 = document.getElementById('doughnutChart');
                if(ctx2) {
                    if(doughnutChart) doughnutChart.destroy();
                    const tot = Object.keys(appState.status).length, done = Object.values(appState.status).filter(x=>x).length;
                    doughnutChart = new Chart(ctx2, {
                        type: 'doughnut',
                        data: { labels: ['Listo', 'Falta'], datasets: [{ data: [done, tot-done], backgroundColor: ['#22d3ee', '#1e293b'], borderWidth: 0 }] },
                        options: { responsive: true, maintainAspectRatio: false, cutout: '85%', plugins: { legend: { display: false } } }
                    });
                }
            },
            
            // Generación de Reporte PDF con Evidencia y Justificación Legal
            downloadReport: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const date = new Date().toLocaleDateString('es-CL');
                const done = Object.values(appState.status).filter(x=>x).length, total = Object.keys(appState.status).length;
                
                // Configuración de Fuente y Colores
                doc.setFont('Helvetica', 'Bold');
                
                // Header Cyberpunk
                doc.setFillColor(15, 23, 42); // Slate 900
                doc.rect(0, 0, 210, 30, 'F');
                doc.setFontSize(24); doc.setTextColor(34, 211, 238); // Cyan 400
                doc.text("NEXUS COMPLIANCE SYSTEM", 105, 18, null, null, "center");
                
                // Metadata
                doc.setFontSize(10); doc.setTextColor(150);
                doc.setFont('Helvetica', 'Normal');
                doc.text(`Informe de Auditoría Interna Detallada - DTO. N° 4/2009`, 105, 38, null, null, "center");
                doc.text(`Fecha de Generación: ${date}`, 105, 43, null, null, "center");
                
                // Resumen
                doc.setFontSize(14); doc.setTextColor(0);
                doc.setFont('Helvetica', 'Bold');
                doc.text(`Estado Global de Cumplimiento: ${Math.round((done/total)*100)}% (${done}/${total})`, 20, 55);
                
                let y = 65;
                const marginX = 20;
                
                regulationData.sections.forEach(s => {
                    if(y > 270) { doc.addPage(); y = 20; }
                    
                    // Título de Sección
                    doc.setFontSize(14); doc.setTextColor(34, 211, 238); // Cyan 400
                    doc.setFont('Helvetica', 'Bold');
                    doc.text(s.title, marginX, y); 
                    doc.setDrawColor(34, 211, 238); doc.line(marginX, y+2, 190, y+2);
                    y += 10;
                    
                    s.items.forEach(i => {
                        if(y > 280) { doc.addPage(); y = 20; }
                        
                        const isCompliant = appState.status[i.id];
                        const statusText = isCompliant ? "CUMPLE" : "PENDIENTE";
                        const note = appState.notes[i.id] || '';
                        const timestamp = appState.timestamps[i.id] ? new Date(appState.timestamps[i.id]).toLocaleDateString('es-CL') : 'N/A';
                        
                        // Estado y Referencia
                        doc.setFontSize(10); 
                        doc.setFont('Helvetica', 'Bold');
                        doc.setTextColor(isCompliant ? 0 : 255, isCompliant ? 150 : 0, 0); // Verde vs Rojo
                        doc.text(`[${statusText}]`, marginX, y);
                        
                        doc.setTextColor(0);
                        doc.setFont('Helvetica', 'Normal');
                        doc.text(`${i.text} (${i.ref})`, marginX + 30, y);
                        
                        // Trazabilidad (Fecha)
                        doc.setTextColor(100);
                        doc.setFontSize(8);
                        doc.text(`Mod: ${timestamp}`, 190, y, null, null, "right");
                        
                        y += 5;

                        // Evidencia (Notas)
                        if(note) {
                            doc.setTextColor(50);
                            doc.setFontSize(9);
                            const lines = doc.splitTextToSize(`Evidencia: ${note}`, 160);
                            doc.text(lines, marginX + 35, y);
                            y += (lines.length * 4) + 2; 
                        } else {
                            doc.setTextColor(150);
                            doc.setFontSize(9);
                            doc.text(`Evidencia: No Registrada`, marginX + 35, y);
                            y += 4;
                        }
                        
                        // Justificación Legal (Solo si está PENDIENTE)
                        if (!isCompliant) {
                            const refKey = i.ref; // Ejemplo: 'Art 3', 'Art 5', 'Art 18'
                            const justificationText = regulationText[refKey];
                            
                            if (justificationText) {
                                y += 2;
                                doc.setFillColor(242, 219, 219); // Rojo claro de fondo
                                doc.rect(marginX + 30, y, 160, 0.1, 'F'); // Línea divisora
                                
                                doc.setTextColor(179, 102, 102); // Rojo oscuro
                                doc.setFont('Helvetica', 'Bold');
                                doc.setFontSize(9);
                                doc.text('BASE LEGAL (Motivo del Incumplimiento):', marginX + 35, y + 4);
                                
                                doc.setTextColor(51, 51, 51); // Gris oscuro
                                doc.setFont('Helvetica', 'Italic');
                                doc.setFontSize(8);
                                const lines = doc.splitTextToSize(justificationText, 155);
                                doc.text(lines, marginX + 35, y + 8);
                                y += (lines.length * 3.5) + 12; // Ajustar el salto de línea para el texto legal
                            } else {
                                y += 4;
                            }
                        } else {
                           y += 4; 
                        }
                         y += 2; // Espacio final entre ítems
                    });
                    y += 5; // Espacio entre secciones
                });
                
                doc.save(`Nexus_Reporte_Auditoria_${date.replace(/\//g,'-')}.pdf`);
                app.showModal("Informe Generado", "El PDF detallado con la evidencia y justificación legal para los pendientes se ha descargado correctamente.");
            }
        };

        const router = { 
            navigate: (v) => { 
                appState.currentView = v; 
                document.getElementById('view-container').innerHTML = views[v](); 
                
                // Actualizar estilo del sidebar
                document.querySelectorAll('.nav-item').forEach(e => {
                    e.classList.toggle('text-cyan-400', e.getAttribute('onclick').includes(v));
                    e.classList.toggle('bg-slate-800', e.getAttribute('onclick').includes(v));
                    e.classList.toggle('border-cyan-400', e.getAttribute('onclick').includes(v));
                    e.classList.toggle('text-slate-400', !e.getAttribute('onclick').includes(v));
                    e.classList.toggle('border-transparent', !e.getAttribute('onclick').includes(v));
                });
                
                // Renderizar gráficos si estamos en el dashboard
                if(v === 'dashboard') setTimeout(app.renderCharts, 100); 
            } 
        };
        
        // Iniciar la aplicación al cargar la ventana
        window.onload = app.init;
    </script>
</body>
</html>
